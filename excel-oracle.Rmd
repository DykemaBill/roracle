---
title: "Excel/CSV to Oracle Example"
author: "Dykema, Bill"
date: "2021/09/15"
output:
  html_document: default
---

## Notes for exporting to HTML file:
#### Set working directory: setwd("[Working Folder]")
#### install.packages("rmarkdown")
#### Knit to HTML for easy viewing: rmarkdown::render("excel-oracle.Rmd", "all")

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Excel/CSV to Oracle example

## Load R libraries

```{r libraries}

# Data analysis packages
#install.packages("tidyverse")
library(tidyverse)

# Excel packages
#install.packages("xlsx")
library(xlsx)

# ODBC package used for Oracle
# install.packages("RODBC")
library(RODBC)

```

## Read CSV file

```{r read_csv_file}

# Create DataFrame from CSV file
df_csv <- read.csv("testtable_source.csv", stringsAsFactors=FALSE)

# View your new DataFrame
df_csv

```

## Read Excel file

```{r read_excel_file}

# Create DataFrame from Excel file
df_excel <- read.xlsx2("testtable_source.xlsx", sheetIndex=1)

# View your new DataFrame
df_excel

```

## CSV Columns

```{r csv_columns}

# Display DataFrame columns
summary(df_csv)
str(df_csv)

```

## Excel Columns

```{r excel_columns}

# Display DataFrame columns
summary(df_excel)
str(df_excel)

```

## CSV Setup Columns

```{r csv_columns_setup}

## Rename columns
df_csv %>%
  rename(test_datetime = TEST_DATETIME) %>%
  rename(test_number = TEST_NUMBER) %>%
  rename(test_text = TEST_TEXT) %>%
  rename(record_added = RECORD_ADDED) ->
df_csv_transformed

```

## Excel Setup Columns

```{r excel_columns_setup}

# Rename columns
df_excel %>%
  rename(test_datetime = TEST_DATETIME) %>%
  rename(test_number = TEST_NUMBER) %>%
  rename(test_text = TEST_TEXT) %>%
  rename(record_added = RECORD_ADDED) ->
df_excel_transformed

# Format date fields in DataFrame
df_excel_transformed[['test_datetime']] <- openxlsx::convertToDateTime(df_excel[['TEST_DATETIME']])
df_excel_transformed[['record_added']] <- openxlsx::convertToDateTime(df_excel[['RECORD_ADDED']])

```

## CSV Update Record Added Fields
```{r csv_updated}

# Get the current date/time
now_is <- Sys.time()

# Populate the updated date/time
df_csv_transformed[['record_added']] <- now_is

```

## Excel Update Record Added Fields
```{r excel_updated}

## Get the current date/time
now_is <- Sys.time()

## Populate the updated date/time
df_excel_transformed[['record_added']] <- now_is

```

## Oracle Setup and Test

```{r oracle_setup_test}

# Connection string (assumes Oracle ODBC DSN is already configured)
odbc_dsn <- "DSNNameHere"

# Table to use for test
test_table <- "testtable"

# Query to use for test
test_query <- sprintf("SELECT * FROM %s", test_table)

# Connect to DSN string
oracle_odbc <- odbcConnect(odbc_dsn)

# Run test query
df_oracle <- sqlQuery(oracle_odbc, test_query)

# Display results of test query
df_oracle

```

## Optional Drop Table before Loading Data

```{r oracle_drop}

# Drop table
sqlDrop(oracle_odbc, test_table, errors=TRUE)

```

## Append CSV to Oracle

```{r csv_oracle_append}

# Append CSV DataFrame to Oracle table


```